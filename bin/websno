#!/usr/bin/env python

import sys

import websno

import websno.server
from websno.stream import EventPickleFile, RATRootFile, ZDABFile, OrcaJSONStream, ZDABDispatch, CouchDBChanges
from websno.store import MemoryStore, CouchDBStore, CrateSlotStore, RackStore
from websno.apps.websnoed import EventViewerNamespace

from websno.record import Record

if __name__ == '__main__':
    # event source
    if len(sys.argv) > 1:
        if sys.argv[1].endswith('.pickle'):
            event_stream = EventPickleFile(sys.argv[1])
        elif sys.argv[1].endswith('.root'):    
            event_stream = RATRootFile(sys.argv[1])
        elif sys.argv[1].endswith('.zdab'):
            event_stream = ZDABFile(sys.argv[1])
        else:
            event_stream = ZDABDispatch(sys.argv[1])

    if event_stream:
        if hasattr(event_stream, 'get'):
            EventViewerNamespace.event_getter = event_stream.get

    # data stores
    crate_slot_store = CrateSlotStore()
    rack_store = RackStore()

    # data streams
    ios_stream = CouchDBChanges('http://localhost:5984', 'iostemp')

    # record types
    websno.records = {
        'event_data': Record('event_data', event_stream),
        'rack_voltages': Record('rack_voltages', ios_stream, rack_store)
    }

    # start streams
    event_stream.start()
    ios_stream.start()

    # start web/socket server
    websno.server.serve()

    # wait for threads to exit
    event_stream.join()
    ios_stream.join()

